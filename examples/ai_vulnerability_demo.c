/**
 * SPDX-FileCopyrightText: 2025 AI-Enhanced OpenVAS Project
 * SPDX-License-Identifier: GPL-2.0-or-later
 * 
 * AI-Enhanced OpenVAS Demonstration Program
 * 
 * This example demonstrates how to use the AI integration features
 * with OpenVAS vulnerability scanning results.
 */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <glib.h>
#include <json-glib/json-glib.h>
#include "../ai-engine/api/ai_service.h"
#include "../plugins/vulnerability-analysis/ai_vuln_analyzer.h"

/* Demo configuration */
#define DEMO_API_KEY_FILE "demo_api_key.txt"
#define DEMO_RESULTS_FILE "demo_scan_results.json"

/**
 * @brief Load API key from file or environment
 */
static gchar *
load_api_key(void)
{
    gchar *api_key = NULL;
    
    // Try environment variable first
    api_key = g_strdup(g_getenv("OPENAI_API_KEY"));
    if (api_key && strlen(api_key) > 0) {
        g_print("✅ Using API key from environment variable\n");
        return api_key;
    }
    
    // Try loading from file
    GError *error = NULL;
    if (g_file_get_contents(DEMO_API_KEY_FILE, &api_key, NULL, &error)) {
        g_strstrip(api_key); // Remove whitespace
        if (strlen(api_key) > 0) {
            g_print("✅ Using API key from file: %s\n", DEMO_API_KEY_FILE);
            return api_key;
        }
    }
    
    if (error) {
        g_error_free(error);
    }
    
    g_free(api_key);
    return NULL;
}

/**
 * @brief Create sample vulnerability data for demonstration
 */
static JsonObject *
create_sample_vulnerability_data(void)
{
    JsonBuilder *builder = json_builder_new();
    
    json_builder_begin_object(builder);
    
    // Basic vulnerability information
    json_builder_set_member_name(builder, "nvt_oid");
    json_builder_add_string_value(builder, "1.3.6.1.4.1.25623.1.0.12345");
    
    json_builder_set_member_name(builder, "name");
    json_builder_add_string_value(builder, "Apache HTTP Server Remote Code Execution");
    
    json_builder_set_member_name(builder, "description");
    json_builder_add_string_value(builder, 
        "A critical vulnerability in Apache HTTP Server allows remote attackers "
        "to execute arbitrary code via a specially crafted HTTP request. "
        "This vulnerability affects versions 2.4.0 through 2.4.48.");
    
    json_builder_set_member_name(builder, "severity");
    json_builder_add_string_value(builder, "Critical");
    
    json_builder_set_member_name(builder, "cvss_score");
    json_builder_add_string_value(builder, "9.8");
    
    json_builder_set_member_name(builder, "cvss_vector");
    json_builder_add_string_value(builder, "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H");
    
    json_builder_set_member_name(builder, "cve_ids");
    json_builder_begin_array(builder);
    json_builder_add_string_value(builder, "CVE-2023-12345");
    json_builder_add_string_value(builder, "CVE-2023-12346");
    json_builder_end_array(builder);
    
    // Host information
    json_builder_set_member_name(builder, "host");
    json_builder_begin_object(builder);
    json_builder_set_member_name(builder, "ip");
    json_builder_add_string_value(builder, "192.168.1.100");
    json_builder_set_member_name(builder, "hostname");
    json_builder_add_string_value(builder, "web-server.example.com");
    json_builder_set_member_name(builder, "os");
    json_builder_add_string_value(builder, "Ubuntu 20.04 LTS");
    json_builder_end_object(builder);
    
    // Service information
    json_builder_set_member_name(builder, "service");
    json_builder_begin_object(builder);
    json_builder_set_member_name(builder, "port");
    json_builder_add_int_value(builder, 80);
    json_builder_set_member_name(builder, "protocol");
    json_builder_add_string_value(builder, "tcp");
    json_builder_set_member_name(builder, "service_name");
    json_builder_add_string_value(builder, "http");
    json_builder_set_member_name(builder, "version");
    json_builder_add_string_value(builder, "Apache/2.4.41");
    json_builder_end_object(builder);
    
    // Additional context
    json_builder_set_member_name(builder, "context");
    json_builder_begin_object(builder);
    json_builder_set_member_name(builder, "business_critical");
    json_builder_add_boolean_value(builder, TRUE);
    json_builder_set_member_name(builder, "internet_facing");
    json_builder_add_boolean_value(builder, TRUE);
    json_builder_set_member_name(builder, "data_classification");
    json_builder_add_string_value(builder, "Confidential");
    json_builder_set_member_name(builder, "compliance_requirements");
    json_builder_begin_array(builder);
    json_builder_add_string_value(builder, "PCI-DSS");
    json_builder_add_string_value(builder, "SOX");
    json_builder_end_array(builder);
    json_builder_end_object(builder);
    
    json_builder_end_object(builder);
    
    JsonNode *root = json_builder_get_root(builder);
    JsonObject *vulnerability_data = json_object_ref(json_node_get_object(root));
    
    g_object_unref(builder);
    
    return vulnerability_data;
}

/**
 * @brief Demonstrate basic AI vulnerability analysis
 */
static void
demo_basic_vulnerability_analysis(const gchar *api_key)
{
    g_print("\n" "=" * 60 "\n");
    g_print("🔍 Basic AI Vulnerability Analysis Demo\n");
    g_print("=" * 60 "\n");
    
    // Create sample vulnerability data
    JsonObject *vuln_data = create_sample_vulnerability_data();
    
    // Create AI request
    ai_request_t *request = ai_request_new(AI_TASK_VULNERABILITY_ANALYSIS, vuln_data);
    if (!request) {
        g_print("❌ Failed to create AI request\n");
        json_object_unref(vuln_data);
        return;
    }
    
    // Configure AI service
    ai_config_t *config = ai_config_new(AI_PROVIDER_OPENAI, api_key);
    config->timeout = 30; // 30 second timeout
    request->config = config;
    
    // Add context for better analysis
    request->context = g_strdup(
        "This is a production web server hosting an e-commerce application. "
        "The server processes credit card transactions and contains customer PII. "
        "Please provide a comprehensive security analysis with business impact assessment."
    );
    
    g_print("📤 Sending vulnerability data to AI for analysis...\n");
    g_print("   Vulnerability: %s\n", json_object_get_string_member(vuln_data, "name"));
    g_print("   Severity: %s\n", json_object_get_string_member(vuln_data, "severity"));
    g_print("   CVSS Score: %s\n", json_object_get_string_member(vuln_data, "cvss_score"));
    
    // Process request (this would normally make an API call)
    g_print("⏳ Processing AI analysis...\n");
    
    // Note: In a real scenario, this would make an actual API call
    // For demo purposes, we'll simulate a response
    g_print("ℹ️  Note: This demo uses simulated AI responses (no actual API call)\n");
    
    // Simulate AI response
    ai_response_t *response = ai_response_new();
    response->success = TRUE;
    response->confidence_score = 0.92;
    response->processing_time_ms = 2500;
    
    JsonObject *result = json_object_new();
    json_object_set_string_member(result, "content", 
        "CRITICAL SECURITY ANALYSIS:\n\n"
        "RISK ASSESSMENT:\n"
        "This Apache HTTP Server vulnerability poses an EXTREME risk to your organization. "
        "With a CVSS score of 9.8, this represents a critical security flaw that allows "
        "remote code execution without authentication.\n\n"
        "BUSINESS IMPACT:\n"
        "- IMMEDIATE: Complete server compromise possible\n"
        "- DATA BREACH: Customer PII and payment data at risk\n"
        "- COMPLIANCE: PCI-DSS and SOX violations likely\n"
        "- FINANCIAL: Potential for significant financial losses\n"
        "- REPUTATION: Severe damage to company reputation\n\n"
        "REMEDIATION PRIORITY: EMERGENCY (Patch within 24 hours)\n\n"
        "RECOMMENDED ACTIONS:\n"
        "1. IMMEDIATE: Take server offline if possible\n"
        "2. URGENT: Apply Apache security patch to version 2.4.49+\n"
        "3. IMPLEMENT: Web Application Firewall (WAF) rules\n"
        "4. MONITOR: Implement enhanced logging and monitoring\n"
        "5. VALIDATE: Conduct penetration testing post-patch\n\n"
        "EXPLOIT LIKELIHOOD: HIGH - Public exploits available\n"
        "ATTACK VECTORS: Remote network access, no authentication required\n"
        "MITIGATION: Immediate patching is the only effective solution"
    );
    json_object_set_string_member(result, "provider", "openai");
    response->result = result;
    
    // Display results
    if (response->success) {
        g_print("\n✅ AI Analysis Complete!\n");
        g_print("🎯 Confidence Score: %.1f%%\n", response->confidence_score * 100);
        g_print("⏱️  Processing Time: %ldms\n", response->processing_time_ms);
        g_print("\n📋 AI Analysis Results:\n");
        g_print("%s\n", json_object_get_string_member(response->result, "content"));
    } else {
        g_print("❌ AI analysis failed: %s\n", response->error_message);
    }
    
    // Cleanup
    ai_response_free(response);
    ai_request_free(request);
    ai_config_free(config);
    json_object_unref(vuln_data);
}

/**
 * @brief Demonstrate threat modeling analysis
 */
static void
demo_threat_modeling(const gchar *api_key)
{
    g_print("\n" "=" * 60 "\n");
    g_print("🎯 AI Threat Modeling Demo\n");
    g_print("=" * 60 "\n");
    
    // Create system information for threat modeling
    JsonBuilder *builder = json_builder_new();
    json_builder_begin_object(builder);
    
    json_builder_set_member_name(builder, "system_name");
    json_builder_add_string_value(builder, "E-commerce Web Application");
    
    json_builder_set_member_name(builder, "architecture");
    json_builder_begin_object(builder);
    json_builder_set_member_name(builder, "frontend");
    json_builder_add_string_value(builder, "React.js SPA");
    json_builder_set_member_name(builder, "backend");
    json_builder_add_string_value(builder, "Node.js API");
    json_builder_set_member_name(builder, "database");
    json_builder_add_string_value(builder, "PostgreSQL");
    json_builder_set_member_name(builder, "cache");
    json_builder_add_string_value(builder, "Redis");
    json_builder_end_object(builder);
    
    json_builder_set_member_name(builder, "data_types");
    json_builder_begin_array(builder);
    json_builder_add_string_value(builder, "Customer PII");
    json_builder_add_string_value(builder, "Payment card data");
    json_builder_add_string_value(builder, "Order history");
    json_builder_add_string_value(builder, "Authentication tokens");
    json_builder_end_array(builder);
    
    json_builder_set_member_name(builder, "external_integrations");
    json_builder_begin_array(builder);
    json_builder_add_string_value(builder, "Payment processor API");
    json_builder_add_string_value(builder, "Shipping provider API");
    json_builder_add_string_value(builder, "Email service");
    json_builder_add_string_value(builder, "Analytics platform");
    json_builder_end_array(builder);
    
    json_builder_end_object(builder);
    
    JsonNode *root = json_builder_get_root(builder);
    JsonObject *system_data = json_object_ref(json_node_get_object(root));
    
    // Create threat modeling request
    ai_request_t *request = ai_request_new(AI_TASK_THREAT_MODELING, system_data);
    ai_config_t *config = ai_config_new(AI_PROVIDER_OPENAI, api_key);
    request->config = config;
    
    g_print("📤 Analyzing system architecture for potential threats...\n");
    g_print("   System: %s\n", json_object_get_string_member(system_data, "system_name"));
    g_print("   Components: Frontend, Backend API, Database, Cache\n");
    g_print("   Data Types: PII, Payment data, Authentication tokens\n");
    
    // Simulate threat modeling response
    g_print("⏳ Performing AI threat analysis...\n");
    g_print("ℹ️  Note: This demo uses simulated AI responses\n");
    
    ai_response_t *response = ai_response_new();
    response->success = TRUE;
    response->confidence_score = 0.88;
    response->processing_time_ms = 3200;
    
    JsonObject *result = json_object_new();
    json_object_set_string_member(result, "content",
        "THREAT MODELING ANALYSIS:\n\n"
        "IDENTIFIED THREAT CATEGORIES:\n"
        "1. INJECTION ATTACKS\n"
        "   - SQL Injection via API endpoints\n"
        "   - NoSQL Injection in database queries\n"
        "   - Command Injection in system calls\n\n"
        "2. AUTHENTICATION & AUTHORIZATION\n"
        "   - JWT token manipulation\n"
        "   - Session hijacking\n"
        "   - Privilege escalation\n"
        "   - Brute force attacks\n\n"
        "3. DATA EXPOSURE\n"
        "   - PII leakage through API responses\n"
        "   - Payment data exposure\n"
        "   - Database credential exposure\n"
        "   - Log file information disclosure\n\n"
        "4. EXTERNAL INTEGRATION RISKS\n"
        "   - Payment processor API abuse\n"
        "   - Third-party service compromise\n"
        "   - Supply chain attacks\n\n"
        "5. INFRASTRUCTURE THREATS\n"
        "   - Container escape\n"
        "   - Network segmentation bypass\n"
        "   - DDoS attacks\n"
        "   - Man-in-the-middle attacks\n\n"
        "ATTACK VECTORS:\n"
        "- Web application vulnerabilities\n"
        "- API endpoint exploitation\n"
        "- Database direct access\n"
        "- Social engineering\n"
        "- Insider threats\n\n"
        "RECOMMENDED SECURITY CONTROLS:\n"
        "1. Input validation and sanitization\n"
        "2. Multi-factor authentication\n"
        "3. API rate limiting and monitoring\n"
        "4. Database encryption at rest\n"
        "5. Network segmentation\n"
        "6. Regular security assessments\n"
        "7. Incident response procedures"
    );
    response->result = result;
    
    if (response->success) {
        g_print("\n✅ Threat Modeling Complete!\n");
        g_print("🎯 Confidence Score: %.1f%%\n", response->confidence_score * 100);
        g_print("⏱️  Processing Time: %ldms\n", response->processing_time_ms);
        g_print("\n📋 Threat Analysis Results:\n");
        g_print("%s\n", json_object_get_string_member(response->result, "content"));
    }
    
    // Cleanup
    ai_response_free(response);
    ai_request_free(request);
    ai_config_free(config);
    json_object_unref(system_data);
    g_object_unref(builder);
}

/**
 * @brief Demonstrate scan optimization
 */
static void
demo_scan_optimization(const gchar *api_key)
{
    g_print("\n" "=" * 60 "\n");
    g_print("⚡ AI Scan Optimization Demo\n");
    g_print("=" * 60 "\n");
    
    // Create target information
    JsonBuilder *builder = json_builder_new();
    json_builder_begin_object(builder);
    
    json_builder_set_member_name(builder, "target_network");
    json_builder_add_string_value(builder, "192.168.1.0/24");
    
    json_builder_set_member_name(builder, "discovered_hosts");
    json_builder_begin_array(builder);
    json_builder_add_string_value(builder, "192.168.1.10 (Windows Server 2019)");
    json_builder_add_string_value(builder, "192.168.1.20 (Ubuntu 20.04)");
    json_builder_add_string_value(builder, "192.168.1.30 (CentOS 8)");
    json_builder_add_string_value(builder, "192.168.1.100 (Apache Web Server)");
    json_builder_end_array(builder);
    
    json_builder_set_member_name(builder, "open_ports");
    json_builder_begin_object(builder);
    json_builder_set_member_name(builder, "192.168.1.10");
    json_builder_begin_array(builder);
    json_builder_add_int_value(builder, 80);
    json_builder_add_int_value(builder, 443);
    json_builder_add_int_value(builder, 3389);
    json_builder_end_array(builder);
    json_builder_set_member_name(builder, "192.168.1.20");
    json_builder_begin_array(builder);
    json_builder_add_int_value(builder, 22);
    json_builder_add_int_value(builder, 80);
    json_builder_end_array(builder);
    json_builder_end_object(builder);
    
    json_builder_set_member_name(builder, "scan_constraints");
    json_builder_begin_object(builder);
    json_builder_set_member_name(builder, "time_window");
    json_builder_add_string_value(builder, "2 hours");
    json_builder_set_member_name(builder, "business_hours");
    json_builder_add_boolean_value(builder, FALSE);
    json_builder_set_member_name(builder, "bandwidth_limit");
    json_builder_add_string_value(builder, "10 Mbps");
    json_builder_end_object(builder);
    
    json_builder_end_object(builder);
    
    JsonNode *root = json_builder_get_root(builder);
    JsonObject *scan_data = json_object_ref(json_node_get_object(root));
    
    // Create optimization request
    ai_request_t *request = ai_request_new(AI_TASK_SCAN_OPTIMIZATION, scan_data);
    ai_config_t *config = ai_config_new(AI_PROVIDER_OPENAI, api_key);
    request->config = config;
    
    g_print("📤 Optimizing scan parameters with AI...\n");
    g_print("   Target Network: %s\n", json_object_get_string_member(scan_data, "target_network"));
    g_print("   Discovered Hosts: 4\n");
    g_print("   Time Window: 2 hours\n");
    g_print("   Business Hours: No\n");
    
    g_print("⏳ Analyzing optimal scan strategy...\n");
    g_print("ℹ️  Note: This demo uses simulated AI responses\n");
    
    // Simulate optimization response
    ai_response_t *response = ai_response_new();
    response->success = TRUE;
    response->confidence_score = 0.91;
    response->processing_time_ms = 1800;
    
    JsonObject *result = json_object_new();
    json_object_set_string_member(result, "content",
        "SCAN OPTIMIZATION RECOMMENDATIONS:\n\n"
        "PRIORITIZED SCAN ORDER:\n"
        "1. 192.168.1.100 (Apache Web Server) - HIGH PRIORITY\n"
        "   - Internet-facing service\n"
        "   - Common attack target\n"
        "   - Recommended NVTs: Web application tests, Apache-specific checks\n\n"
        "2. 192.168.1.10 (Windows Server 2019) - MEDIUM PRIORITY\n"
        "   - RDP service exposed (port 3389)\n"
        "   - Potential domain controller\n"
        "   - Recommended NVTs: Windows authentication, SMB tests\n\n"
        "3. 192.168.1.20 (Ubuntu 20.04) - MEDIUM PRIORITY\n"
        "   - SSH service (port 22)\n"
        "   - Web service (port 80)\n"
        "   - Recommended NVTs: SSH configuration, Linux kernel checks\n\n"
        "4. 192.168.1.30 (CentOS 8) - LOW PRIORITY\n"
        "   - Minimal exposed services\n"
        "   - Standard Linux hardening checks\n\n"
        "OPTIMIZED SCAN PARAMETERS:\n"
        "- Concurrent targets: 2 (bandwidth optimization)\n"
        "- Scan intensity: Medium (time constraint)\n"
        "- Port scan method: SYN scan (stealth + speed)\n"
        "- NVT selection: Risk-based filtering\n"
        "- Timing template: Aggressive (off-hours)\n\n"
        "ESTIMATED COMPLETION TIME: 1.5 hours\n"
        "BANDWIDTH UTILIZATION: 8 Mbps average\n"
        "DETECTION RISK: Low (off-hours scanning)\n\n"
        "RECOMMENDED EXCLUSIONS:\n"
        "- Skip non-critical informational checks\n"
        "- Exclude DoS-prone tests during business hours\n"
        "- Focus on exploitable vulnerabilities\n\n"
        "PERFORMANCE OPTIMIZATIONS:\n"
        "- Enable scan result caching\n"
        "- Use parallel NVT execution\n"
        "- Implement adaptive timing based on response"
    );
    response->result = result;
    
    if (response->success) {
        g_print("\n✅ Scan Optimization Complete!\n");
        g_print("🎯 Confidence Score: %.1f%%\n", response->confidence_score * 100);
        g_print("⏱️  Processing Time: %ldms\n", response->processing_time_ms);
        g_print("\n📋 Optimization Results:\n");
        g_print("%s\n", json_object_get_string_member(response->result, "content"));
    }
    
    // Cleanup
    ai_response_free(response);
    ai_request_free(request);
    ai_config_free(config);
    json_object_unref(scan_data);
    g_object_unref(builder);
}

/**
 * @brief Main demonstration function
 */
int
main(int argc, char *argv[])
{
    g_print("🚀 AI-Enhanced OpenVAS Demonstration\n");
    g_print("=" * 60 "\n");
    g_print("This demo showcases the AI integration capabilities of the\n");
    g_print("enhanced OpenVAS vulnerability assessment platform.\n");
    
    // Initialize AI service
    if (!ai_service_init()) {
        g_print("❌ Failed to initialize AI service\n");
        return EXIT_FAILURE;
    }
    
    // Load API key
    gchar *api_key = load_api_key();
    if (!api_key) {
        g_print("\n⚠️  No API key found!\n");
        g_print("To run with real AI analysis, please:\n");
        g_print("1. Set environment variable: export OPENAI_API_KEY=your_key_here\n");
        g_print("2. Or create file: %s with your API key\n", DEMO_API_KEY_FILE);
        g_print("\nContinuing with simulated responses...\n");
        api_key = g_strdup("demo-key");
    }
    
    // Run demonstrations
    demo_basic_vulnerability_analysis(api_key);
    demo_threat_modeling(api_key);
    demo_scan_optimization(api_key);
    
    // Summary
    g_print("\n" "=" * 60 "\n");
    g_print("🎉 AI-Enhanced OpenVAS Demo Complete!\n");
    g_print("=" * 60 "\n");
    g_print("This demonstration showed:\n");
    g_print("✅ AI-powered vulnerability analysis with business impact\n");
    g_print("✅ Intelligent threat modeling for system architecture\n");
    g_print("✅ AI-driven scan optimization for efficiency\n");
    g_print("\nNext steps:\n");
    g_print("1. Integrate with your OpenVAS installation\n");
    g_print("2. Configure AI providers with your API keys\n");
    g_print("3. Customize AI prompts for your environment\n");
    g_print("4. Implement additional AI-powered features\n");
    
    // Cleanup
    g_free(api_key);
    ai_service_cleanup();
    
    return EXIT_SUCCESS;
}