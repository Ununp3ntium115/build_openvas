/**
 * SPDX-FileCopyrightText: 2025 AI-Enhanced OpenVAS Project
 * SPDX-License-Identifier: GPL-2.0-or-later
 * 
 * Scanner Integration Demo
 * Demonstrates how external data sources integrate with OpenVAS scanning
 */

#include <stdio.h>
#include <glib.h>
#include <json-glib/json-glib.h>
#include \"../ai-engine/integration/scanner_bridge.h\"
#include \"../ai-engine/scoring/vulnerability_scoring.h\"

/**
 * @brief Simulate NASL plugin detecting a vulnerability
 */
void
simulate_nasl_plugin_detection(void)
{
    g_print(\"\\n🔍 Simulating NASL Plugin Vulnerability Detection\\n\");
    g_print(\"=\" * 50 \"\\n\");
    
    // Simulate different vulnerabilities being detected during a scan
    const gchar *test_vulnerabilities[] = {
        \"CVE-2023-44487\",  // HTTP/2 Rapid Reset (KEV, high EPSS)\n        \"CVE-2021-44228\",  // Log4Shell (KEV, critical)\n        \"CVE-2023-23397\",  // Outlook Elevation of Privilege (KEV)\n        \"CVE-2023-21716\",  // Microsoft Word RCE\n        \"CVE-2023-36884\",  // Windows Search RCE\n        NULL\n    };\n    \n    const gchar *test_hosts[] = {\n        \"192.168.1.10\",\n        \"192.168.1.20\",\n        \"192.168.1.30\",\n        NULL\n    };\n    \n    gint test_ports[] = { 80, 443, 22, 3389, 445, 0 };\n    \n    // Start a simulated scan\n    const gchar *scan_id = \"demo-scan-001\";\n    scanner_bridge_start_scan(scan_id);\n    \n    // Simulate vulnerability detections\n    for (gint i = 0; test_vulnerabilities[i]; i++) {\n        const gchar *cve = test_vulnerabilities[i];\n        const gchar *host = test_hosts[i % 3]; // Rotate through hosts\n        gint port = test_ports[i % 5];         // Rotate through ports\n        \n        g_print(\"\\n📍 NASL Plugin detected: %s on %s:%d\\n\", cve, host, port);\n        \n        // This is what would be called from within a NASL plugin\n        nasl_vulnerability_detected(cve, host, port, \n                                   \"1.3.6.1.4.1.25623.1.0.123456\", \n                                   \"Simulated vulnerability detection\");\n        \n        // Small delay to simulate real scanning\n        g_usleep(500000); // 0.5 seconds\n    }\n    \n    // End the scan\n    scanner_bridge_end_scan(scan_id);\n}\n\n/**\n * @brief Demonstrate comprehensive vulnerability scoring\n */\nvoid\ndemonstrate_comprehensive_scoring(void)\n{\n    g_print(\"\\n📊 Comprehensive Vulnerability Scoring Demo\\n\");\n    g_print(\"=\" * 50 \"\\n\");\n    \n    const gchar *demo_cves[] = {\n        \"CVE-2023-44487\",  // HTTP/2 Rapid Reset\n        \"CVE-2021-44228\",  // Log4Shell\n        \"CVE-2023-23397\",  // Outlook EoP\n        NULL\n    };\n    \n    for (gint i = 0; demo_cves[i]; i++) {\n        const gchar *cve_id = demo_cves[i];\n        \n        g_print(\"\\n🎯 Analyzing %s:\\n\", cve_id);\n        g_print(\"-\" * 30 \"\\n\");\n        \n        // Fetch comprehensive vulnerability data\n        vulnerability_score_t *score = get_comprehensive_score(cve_id);\n        if (!score) {\n            g_print(\"❌ Failed to fetch data for %s\\n\", cve_id);\n            continue;\n        }\n        \n        // Display CVSS information\n        if (score->cvss_v3_1) {\n            g_print(\"📈 CVSS v3.1: %.1f (%s)\\n\", \n                   score->cvss_v3_1->base_score,\n                   cvss_severity_to_string(score->cvss_v3_1->severity));\n            g_print(\"   Vector: AV:%s/AC:%s/PR:%s/UI:%s/S:%s/C:%s/I:%s/A:%s\\n\",\n                   score->cvss_v3_1->attack_vector,\n                   score->cvss_v3_1->attack_complexity,\n                   score->cvss_v3_1->privileges_required,\n                   score->cvss_v3_1->user_interaction,\n                   score->cvss_v3_1->scope,\n                   score->cvss_v3_1->confidentiality,\n                   score->cvss_v3_1->integrity,\n                   score->cvss_v3_1->availability);\n        }\n        \n        // Display KEV information\n        if (score->kev) {\n            if (score->kev->is_kev) {\n                g_print(\"🚨 KEV Status: ACTIVE EXPLOITATION\\n\");\n                g_print(\"   Added: %s\\n\", score->kev->date_added);\n                g_print(\"   Due Date: %s\\n\", score->kev->due_date);\n                g_print(\"   Action: %s\\n\", score->kev->required_action);\n            } else {\n                g_print(\"✅ KEV Status: Not in KEV catalog\\n\");\n            }\n        }\n        \n        // Display EPSS information\n        if (score->epss) {\n            g_print(\"🎲 EPSS Score: %.4f (%.1f%% percentile)\\n\", \n                   score->epss->score, score->epss->percentile * 100);\n            g_print(\"   Probability of exploitation in next 30 days: %.2f%%\\n\",\n                   score->epss->score * 100);\n        }\n        \n        // Display SSVC information\n        if (score->ssvc) {\n            g_print(\"⚖️  SSVC Decision: %s\\n\", ssvc_decision_to_string(score->ssvc->decision));\n            g_print(\"   Exploitation: %s\\n\", score->ssvc->exploitation);\n            g_print(\"   Automatable: %s\\n\", score->ssvc->automatable);\n            g_print(\"   Technical Impact: %s\\n\", score->ssvc->technical_impact);\n            g_print(\"   Mission Impact: %s\\n\", score->ssvc->mission_impact);\n        }\n        \n        // Display AI-enhanced information\n        if (score->ai_risk_score > 0.0) {\n            g_print(\"🤖 AI Risk Score: %.1f/100\\n\", score->ai_risk_score);\n            if (score->ai_priority) {\n                g_print(\"   AI Priority: %s\\n\", score->ai_priority);\n            }\n        }\n        \n        // Calculate composite priority\n        gint priority = get_scan_priority_for_vulnerability(score);\n        const gchar *priority_str = \"UNKNOWN\";\n        switch (priority) {\n            case 1: priority_str = \"CRITICAL\"; break;\n            case 2: priority_str = \"HIGH\"; break;\n            case 3: priority_str = \"MEDIUM\"; break;\n            case 4: priority_str = \"LOW\"; break;\n        }\n        \n        g_print(\"🎯 Composite Priority: %s\\n\", priority_str);\n        \n        vulnerability_score_free(score);\n    }\n}\n\n/**\n * @brief Demonstrate AI-enhanced remediation guidance\n */\nvoid\ndemonstrate_ai_guidance(void)\n{\n    g_print(\"\\n🤖 AI-Enhanced Remediation Guidance Demo\\n\");\n    g_print(\"=\" * 50 \"\\n\");\n    \n    // This would normally be called during actual scanning\n    // Here we simulate it for demonstration\n    \n    const gchar *cve_id = \"CVE-2021-44228\"; // Log4Shell\n    vulnerability_score_t *score = get_comprehensive_score(cve_id);\n    \n    if (!score) {\n        g_print(\"❌ Failed to fetch vulnerability data\\n\");\n        return;\n    }\n    \n    // Simulate AI enhancement\n    ai_enhance_vulnerability_score(score);\n    \n    g_print(\"\\n📋 AI-Generated Remediation Guidance for %s:\\n\", cve_id);\n    g_print(\"-\" * 40 \"\\n\");\n    \n    if (score->ai_context) {\n        const gchar *guidance = json_object_get_string_member(score->ai_context, \"remediation_guidance\");\n        if (guidance) {\n            g_print(\"%s\\n\", guidance);\n        }\n        \n        // Display other AI context if available\n        if (json_object_has_member(score->ai_context, \"threat_context\")) {\n            const gchar *threat_context = json_object_get_string_member(score->ai_context, \"threat_context\");\n            g_print(\"\\n🔍 Threat Context:\\n%s\\n\", threat_context);\n        }\n        \n        if (json_object_has_member(score->ai_context, \"business_impact\")) {\n            const gchar *business_impact = json_object_get_string_member(score->ai_context, \"business_impact\");\n            g_print(\"\\n💼 Business Impact:\\n%s\\n\", business_impact);\n        }\n    }\n    \n    vulnerability_score_free(score);\n}\n\n/**\n * @brief Demonstrate report generation with external data\n */\nvoid\ndemonstrate_enhanced_reporting(void)\n{\n    g_print(\"\\n📊 Enhanced Vulnerability Reporting Demo\\n\");\n    g_print(\"=\" * 50 \"\\n\");\n    \n    // Create a sample set of vulnerabilities\n    GPtrArray *vulnerabilities = g_ptr_array_new_with_free_func(\n        (GDestroyNotify)vulnerability_score_free);\n    \n    const gchar *sample_cves[] = {\n        \"CVE-2023-44487\",\n        \"CVE-2021-44228\",\n        \"CVE-2023-23397\",\n        \"CVE-2023-21716\",\n        NULL\n    };\n    \n    // Fetch comprehensive data for each CVE\n    for (gint i = 0; sample_cves[i]; i++) {\n        vulnerability_score_t *score = get_comprehensive_score(sample_cves[i]);\n        if (score) {\n            ai_enhance_vulnerability_score(score);\n            g_ptr_array_add(vulnerabilities, score);\n        }\n    }\n    \n    // Generate comprehensive report\n    JsonObject *report = generate_vulnerability_report(vulnerabilities);\n    \n    // Display report summary\n    g_print(\"\\n📈 Vulnerability Report Summary:\\n\");\n    g_print(\"-\" * 30 \"\\n\");\n    \n    if (json_object_has_member(report, \"summary\")) {\n        JsonObject *summary = json_object_get_object_member(report, \"summary\");\n        \n        gint total = json_object_get_int_member(summary, \"total_vulnerabilities\");\n        gint critical = json_object_get_int_member(summary, \"critical_count\");\n        gint high = json_object_get_int_member(summary, \"high_count\");\n        gint kev_count = json_object_get_int_member(summary, \"kev_count\");\n        \n        g_print(\"Total Vulnerabilities: %d\\n\", total);\n        g_print(\"Critical Severity: %d\\n\", critical);\n        g_print(\"High Severity: %d\\n\", high);\n        g_print(\"KEV Vulnerabilities: %d\\n\", kev_count);\n        \n        if (json_object_has_member(summary, \"avg_epss_score\")) {\n            gdouble avg_epss = json_object_get_double_member(summary, \"avg_epss_score\");\n            g_print(\"Average EPSS Score: %.3f\\n\", avg_epss);\n        }\n    }\n    \n    // Display top vulnerabilities by CVSS\n    JsonArray *top_cvss = get_top_vulnerabilities_by_cvss(vulnerabilities, 3);\n    g_print(\"\\n🔥 Top 3 by CVSS Score:\\n\");\n    for (guint i = 0; i < json_array_get_length(top_cvss); i++) {\n        JsonObject *vuln = json_array_get_object_element(top_cvss, i);\n        const gchar *cve = json_object_get_string_member(vuln, \"cve_id\");\n        gdouble cvss = json_object_get_double_member(vuln, \"cvss_score\");\n        g_print(\"   %d. %s (CVSS: %.1f)\\n\", i + 1, cve, cvss);\n    }\n    \n    // Display KEV vulnerabilities\n    JsonArray *kev_vulns = get_kev_vulnerabilities(vulnerabilities);\n    if (json_array_get_length(kev_vulns) > 0) {\n        g_print(\"\\n🚨 KEV Vulnerabilities (Actively Exploited):\\n\");\n        for (guint i = 0; i < json_array_get_length(kev_vulns); i++) {\n            JsonObject *vuln = json_array_get_object_element(kev_vulns, i);\n            const gchar *cve = json_object_get_string_member(vuln, \"cve_id\");\n            const gchar *due_date = json_object_get_string_member(vuln, \"kev_due_date\");\n            g_print(\"   • %s (Due: %s)\\n\", cve, due_date);\n        }\n    }\n    \n    // Display SSVC Act vulnerabilities\n    JsonArray *act_vulns = get_ssvc_act_vulnerabilities(vulnerabilities);\n    if (json_array_get_length(act_vulns) > 0) {\n        g_print(\"\\n⚡ SSVC 'Act' Vulnerabilities (Immediate Action Required):\\n\");\n        for (guint i = 0; i < json_array_get_length(act_vulns); i++) {\n            JsonObject *vuln = json_array_get_object_element(act_vulns, i);\n            const gchar *cve = json_object_get_string_member(vuln, \"cve_id\");\n            g_print(\"   • %s\\n\", cve);\n        }\n    }\n    \n    // Cleanup\n    json_object_unref(report);\n    json_array_unref(top_cvss);\n    json_array_unref(kev_vulns);\n    json_array_unref(act_vulns);\n    g_ptr_array_free(vulnerabilities, TRUE);\n}\n\n/**\n * @brief Main demonstration function\n */\nint\nmain(int argc, char *argv[])\n{\n    g_print(\"🚀 AI-Enhanced OpenVAS Scanner Integration Demo\\n\");\n    g_print(\"=\" * 60 \"\\n\");\n    \n    // Initialize the scanner bridge\n    if (!scanner_bridge_init()) {\n        g_critical(\"Failed to initialize scanner bridge\");\n        return 1;\n    }\n    \n    // Initialize vulnerability scoring system\n    if (!vulnerability_scoring_init()) {\n        g_critical(\"Failed to initialize vulnerability scoring\");\n        scanner_bridge_cleanup();\n        return 1;\n    }\n    \n    g_print(\"✅ Scanner bridge and vulnerability scoring initialized\\n\");\n    \n    // Run demonstrations\n    simulate_nasl_plugin_detection();\n    demonstrate_comprehensive_scoring();\n    demonstrate_ai_guidance();\n    demonstrate_enhanced_reporting();\n    \n    // Display statistics\n    bridge_stats_t *stats = get_bridge_statistics();\n    if (stats) {\n        g_print(\"\\n📊 Bridge Statistics:\\n\");\n        g_print(\"-\" * 20 \"\\n\");\n        g_print(\"Total vulnerabilities detected: %u\\n\", stats->total_vulnerabilities_detected);\n        g_print(\"KEV vulnerabilities detected: %u\\n\", stats->kev_vulnerabilities_detected);\n        g_print(\"Critical vulnerabilities detected: %u\\n\", stats->critical_vulnerabilities_detected);\n        g_print(\"AI-enhanced results: %u\\n\", stats->ai_enhanced_results);\n        g_print(\"External API calls: %u\\n\", stats->external_api_calls);\n        g_print(\"Cache hits: %u\\n\", stats->cache_hits);\n        g_print(\"Cache misses: %u\\n\", stats->cache_misses);\n        g_print(\"Average enhancement time: %.2f ms\\n\", stats->avg_enhancement_time_ms);\n    }\n    \n    // Cleanup\n    vulnerability_scoring_cleanup();\n    scanner_bridge_cleanup();\n    \n    g_print(\"\\n🎉 Demo completed successfully!\\n\");\n    g_print(\"\\n💡 This demonstrates how external vulnerability data sources\\n\");\n    g_print(\"   integrate seamlessly with OpenVAS scanning to provide\\n\");\n    g_print(\"   comprehensive, AI-enhanced vulnerability analysis.\\n\");\n    \n    return 0;\n}